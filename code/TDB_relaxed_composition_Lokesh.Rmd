---
title: "TDB_relaxed functional composition"
author: "Katja Kozjek"
output: 
  rmarkdown::html_document:
    code_folding: 'hide'
    toc: true
    toc_float: true
    smart: true
    number_sections: false
    highlight: tango
    self_contained: true
    smaller: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r wrap-hook, include=FALSE}
library(knitr)
hook_output = knit_hooks$get('output')
knit_hooks$set(output = function(x, options) {
  # this hook is used only when the linewidth option is not NULL
  if (!is.null(n <- options$linewidth)) {
    x = knitr:::split_lines(x)
    # any lines wider than n should be wrapped
    if (any(nchar(x) > n)) x = strwrap(x, width = n)
    x = paste(x, collapse = '\n')
  }
  hook_output(x, options)
})
```

# Load libraries

```{r load libraries, message=F, warning=F}
library(rafalib) # nice plot arrangement
library(phyloseq)
library(ranacapa) #for rarefaction curves
library(ggplot2)
library(wesanderson)
library(DESeq2)
library(vegan)
library(ggordiplots)
library(scales)
library(dplyr)
library(tibble)
library(devtools)
#library(pairwiseAdonis)
library(limma)
library(cowplot)
library(tidyverse)
```

I am just here trying to look if there is drought effect in Sweden if we remove RC from the analysis completely!

# Upload files

```{r load files, message=FALSE, warning=FALSE}

tdb_fam <- read.csv("../data/dataTDB/TDB_EZfam/TDB_EZfam_rem_filt.counts.tsv", sep = "\t", header = T, row.names = 1)

tdb_acc <- read.csv("../data/dataTDB/TDB_EZacc/TDB_EZacc_rem_filt.counts.tsv",sep = "\t", header = T, row.names = 1)

metafile = read.csv("../data/metafile/metafile_relaxed.csv", sep=",", row.names=1)

metafile_remove <- metafile[-c(58,60),]

#metafile_pca <- read.csv("C:/Users/Katja/Box Sync/PhD Lund Katja/Sequencing/Functional_genes/Diamond/data_TDB/relaxed/metafile_relaxed.csv", sep=",")
#metafile_pca <- metafile_pca[-c(58,60),] #for pca dataframe

sampledata = sample_data(metafile)
sampledata_remove <- sampledata[-c(58,60),]

```

# Sweden 

## EZfam level

```{r SE family level, message=F, warning=F}

se_metadat <- metafile_remove %>%
  filter(country == "SE") %>%
  filter(treatment != "RC")
  
se_metadat$field_pair <- factor(se_metadat$field_pair)

se_tdb_fam <- tdb_fam[,colnames(tdb_fam) %in% rownames(se_metadat)]

se_dds_fam <- DESeqDataSetFromMatrix(countData = se_tdb_fam,
                              colData = se_metadat[match(colnames(se_tdb_fam), rownames(se_metadat)), ],
                              design= ~ field_pair + treatment)

se_vsd_fam <- varianceStabilizingTransformation(se_dds_fam)
se_vsd_fam_counts <- assay(se_vsd_fam)

p1_SE_FP <- plotPCA(se_vsd_fam, "field_pair")
p2_SE_treat <- plotPCA(se_vsd_fam, "treatment")
plot_grid(p1_SE_FP, p2_SE_treat)

#PERMANOVA
se_vsd_fam_counts <- t(se_vsd_fam_counts)
set.seed(4364)
adonis(se_vsd_fam_counts ~ treatment, strata = se_metadat$field_pair, 
       data=se_metadat, permutations=999)

```
***No drought effect on family level***

### batch correction 

```{r SE batch correction, family level, message=F, warning=F}

se_vsd_fam_remFP <- se_vsd_fam
assay(se_vsd_fam_remFP) <- limma::removeBatchEffect(assay(se_vsd_fam_remFP), se_vsd_fam_remFP$field_pair)

p1_SE_FP_corr <- plotPCA(se_vsd_fam_remFP, "field_pair")
p2_SE_treat_corr <- plotPCA(se_vsd_fam_remFP, "treatment")
plot_grid(p1_SE_FP_corr, p2_SE_treat_corr)

#PERMANOVA 
se_vsd_fam_remFP_df <- as.data.frame(assay(se_vsd_fam_remFP))
se_vsd_fam_remFP_df <- t(se_vsd_fam_remFP_df)

set.seed(4364)
adonis2(se_vsd_fam_remFP_df ~ treatment, 
                     data=se_metadat, permutations=999)

```
***No drought effect on family level after batch correction on field pairs***

## EZ ID level

```{r SE ID level, message=F, warning=F}

se_tdb_acc <- tdb_acc[,colnames(tdb_acc) %in% rownames(se_metadat)]

se_dds_acc <- DESeqDataSetFromMatrix(countData = se_tdb_acc,
                              colData = se_metadat[match(colnames(se_tdb_acc), rownames(se_metadat)), ],
                              design= ~ field_pair + treatment)

se_vsd_acc <- varianceStabilizingTransformation(se_dds_acc)
se_vsd_acc_counts <- assay(se_vsd_acc)

p1_SEacc_FP <- plotPCA(se_vsd_acc, "field_pair")
p2_SEacc_treat <- plotPCA(se_vsd_acc, "treatment")
plot_grid(p1_SEacc_FP, p2_SEacc_treat)

#PERMANOVA
se_vsd_acc_counts <- t(se_vsd_acc_counts)
set.seed(4364)
adonis(se_vsd_acc_counts ~ treatment, 
       data=se_metadat, strata=se_metadat$field_pair, permutations=999)

```
***No drought effect on ID level***

### batch correction 

```{r SE batch correction, ID level, message=F, warning=F}

se_vsd_acc_remFP <- se_vsd_acc
assay(se_vsd_acc_remFP) <- limma::removeBatchEffect(assay(se_vsd_acc_remFP), se_vsd_acc_remFP$field_pair)

p1_SEacc_FP_corr <- plotPCA(se_vsd_acc_remFP, "field_pair")
p2_SEacc_treat_corr <- plotPCA(se_vsd_acc_remFP, "treatment")
plot_grid(p1_SEacc_FP_corr, p2_SEacc_treat_corr)

#PERMANOVA 
se_vsd_acc_remFP_df <- as.data.frame(assay(se_vsd_acc_remFP))
se_vsd_acc_remFP_df <- t(se_vsd_acc_remFP_df)

set.seed(4364)
adonis(se_vsd_acc_remFP_df ~ treatment, 
                     data=se_metadat, permutations=999)

```
***Very marginal drought effect on ID level after batch correction with P value of 0.095***

```{r session}

sessionInfo()

```
